import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import type { SubmitHandler } from 'react-hook-form';
import { Controller, useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import userInputValidationSchema from '@zod/validateUserInput';
import {
  TextField,
  Button,
  FormControlLabel,
  Box,
  Typography,
  Checkbox,
} from '@mui/material';

import styles from '@styles/UserInputView.module.css';
import { useCreateLinktaFlowMutation } from '@/hooks/useCreateLinktaFlowMutation';
import SnackBarNotification from '../common/SnackBarNotification';
import type LinktaFlow from '@/types/LinktaFlow';
import { useQueryClient } from '@tanstack/react-query';

interface CustomFormData {
  input: string;
  isChecked: boolean;
}

const UserInputForm = () => {
  // Here we utilize the useForm hook's properties to manage form state while also initializing default values and resolving our validation schema.
  // The control object is used by react-hook-form's Controller to link our UserInputBar and UserInputCheckbox components to the form's state, handling any necessary state updates or validation checks.
  const {
    handleSubmit,
    reset,
    control,
    watch,
    formState: { errors },
  } = useForm({
    resolver: zodResolver(userInputValidationSchema),
    defaultValues: {
      input: '',
      isChecked: JSON.parse('true' || 'false'),
    },
  });
  const navigate = useNavigate();
  const createLinktaFlowMutation = useCreateLinktaFlowMutation();
  const [snackbar, setSnackbar] = useState({
    open: false,
    message: '',
    severity: 'success' as 'error' | 'warning' | 'info' | 'success',
  });
  const queryClient = useQueryClient();

  const isChecked = watch('isChecked');

  const onSubmit: SubmitHandler<CustomFormData> = (data) => {
    createLinktaFlowMutation.mutate(
      { input: data.input },
      {
        onSuccess: async (response: LinktaFlow) => {
          await queryClient.invalidateQueries({ queryKey: ['inputHistory'] });
          reset();
          navigate(`/output/${response.userInputId}`);
          setSnackbar({
            open: true,
            message: 'LinktaFlow created successfully!',
            severity: 'success',
          });
        },
        onError: (error: Error) => {
          console.error('Error sending prompt: ', error);
          setSnackbar({
            open: true,
            message: 'Failed to create LinktaFlow. Please try again.',
            severity: 'error',
          });
        },
      },
    );
  };

  return (
    <>
      <form
        onSubmit={handleSubmit(onSubmit)}
        className={`${styles.userInputForm}`}
      >
        <Typography
          className={`${styles.userInputFormTitle}`}
          variant='h6'
          sx={{ textAlign: 'left', color: 'text.primary', mb: 2 }}
        >
          Start your learning journey here:
        </Typography>

        <Box className={`${styles.inputsContainer}`}>
          <Controller
            name='input'
            control={control}
            render={({ field }) => (
              <TextField
                {...field}
                variant='outlined'
                className={`${styles.userInputTextField}`}
                error={!!errors.input}
                helperText={errors.input ? errors.input.message : ''}
              />
            )}
          />

          <FormControlLabel
            className={`${styles.userInputDisclaimer}`}
            label='Content on this site may be generated by artifical intelligence (AI). Please use discretion and verify information where necessary.'
            sx={{ color: 'text.primary' }}
            control={
              <Controller
                name='isChecked'
                control={control}
                render={({ field }) => (
                  <Checkbox
                    className={`${styles.UserInputCheckbox}`}
                    {...field}
                    checked={field.value}
                  />
                )}
              />
            }
          />
        </Box>

        <Button
          variant='contained'
          className={`${styles.userInputSubmitButton}`}
          type='submit'
          disabled={!isChecked}
        >
          {createLinktaFlowMutation.status === 'pending'
            ? 'Loading'
            : 'Generate'}
        </Button>
      </form>
      <SnackBarNotification
        open={snackbar.open}
        message={snackbar.message}
        severity={snackbar.severity}
        callerUpdater={() => setSnackbar({ ...snackbar, open: false })}
      />
    </>
  );
};

export default UserInputForm;
